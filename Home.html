<html>
	<head>
		<meta charset="utf-8">
	    <meta http-equiv="X-UA-Compatible" content="IE=edge">
	    <meta name="viewport" content="width=device-width, initial-scale=1">
	    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->

		<title>Blinky Controller</title>

		<!-- Bootstrap core CSS -->
    	<link href="./site/dist/css/bootstrap.min.css" rel="stylesheet">

		<!-- Bootstrap theme -->
    	<link href="./site/dist/css/bootstrap-theme.min.css" rel="stylesheet">

		<!-- Bootstrap toggle -->
    	<link href="./dist/css/bootstrap-toggle.min.css" rel="stylesheet">
	</head>
	<body>
		<h1 align="center">Welcome to Blinky Controller!</h1>

		<br>

		<div style="width: 50%; float: left;">
			<h2>Commands</h2>
			{% for command in commands %}
				<input class="command_button" type="radio" name="command" value={{ command }} onclick="handleClick(this);"{% if currentCommand == command %} checked {% endif %}>{{ command }}<br>
			{% endfor %}
		</div>

		<div style="width: 50%; float: left;">
			<h2>Controls</h2>
			<button class="btn btn-lg btn-default" type="button" onclick="sendClear()">Clear</button>
			<button class="btn btn-lg btn-default" type="button" onclick="sendStop()">Stop</button>
		</div>

		<div style="width: 50%; float: right;">
			<h1>Dynamic Color</h1>
			<input id="dyna_off" type="radio" name="dyna" value="false" onclick="handleDyna(this);"{% if dyna_color == false %} checked{% endif %}>Off<br>
			<input id="dyna_on" type="radio" name="dyna" value="true" onclick="handleDyna(this);"{% if dyna_color == true %} checked{% endif %}>On<br>
		</div>

		<div style="width: 50%; float: right;">
			<h1>Speed</h1>
			<input id="speed_input" type="text" name="speed" value={{ speed }} oninput="setSpeed()">
		</div>

		<div style="width: 50%; float: right;">
			<h1>Color</h1>
			<p>Red: </p>
			<input id="red_input" type="text" name="color" value={{ red }} oninput="setColor()"><br>
			<p>Green: </p>
			<input id="green_input" type="text" name="color" value={{ green }} oninput="setColor()"><br>
			<p>Blue: </p>
			<input id="blue_input" type="text" name="color" value={{ blue }} oninput="setColor()"><br>
		</div>

		<script>
		function handleClick(radioButton) {
			var command = radioButton.value;
			console.log("Selected: " + command);
			sendUpdate({"command": command});
		}

		function setSpeed() {
			var speed = parseFloat(document.getElementById("speed_input").value);
			console.log("Speed: "+speed);
			sendUpdate({"speed": speed});
		}

		function setColor() {
			var red = parseInt(document.getElementById("red_input").value);
			var green = parseInt(document.getElementById("green_input").value);
			var blue = parseInt(document.getElementById("blue_input").value);
			var color = [red, green, blue];
			console.log("Color: "+color);
			sendUpdate({"color": color});
		}

		function handleDyna(radioButton) {
			var value = radioButton.value;
			console.log("DynaColor: " + value);
			var boolValue = true;
			if (value == "false") {
				boolValue = false;
			}
			sendUpdate({"dynamic_color": boolValue});
		}

		function sendUpdate(data) {
			var route = "/update";
			sendPOSTRequest(route, data, null);
		}	

		function sendStop() {
			var route = "/stop";
			sendPOSTRequest(route, {}, null);
		}	

		function sendClear() {
			var route = "/clear";
			sendPOSTRequest(route, {}, function(success) {
				var buttons = document.getElementsByClassName("command_button");
				Array.prototype.forEach.call(buttons, function(button) {
					button.checked = false;
				});
			});
		}

		function updateState() {
			sendGETRequest("/state", function(state) {
				if (state) {
					document.getElementById("red_input").value = state.color[0];
					document.getElementById("green_input").value = state.color[1];
					document.getElementById("blue_input").value = state.color[2];
					document.getElementById("dyna_on").checked = state.dyna_color;
					document.getElementById("dyna_off").checked = !state.dyna_color;
					document.getElementById("speed_input").value = state.speed;

					var command_buttons = document.getElementsByClassName("command_button");
					Array.prototype.forEach.call(command_buttons, function(button) {
						if (button.value == state.command) {
							button.checked = true;
						} else {
							button.checked = false;
						}
					});
				}			
			});
		}

		window.setInterval(updateState, 2000);


		// Network Requests

		//http://stackoverflow.com/questions/24468459/sending-a-json-to-server-and-retrieving-a-json-in-return-without-jquery
		function sendRequest(type, route, data, completion) {
			xhr = new XMLHttpRequest();
			xhr.open(type, route, true);
			xhr.onreadystatechange = function() {
				if (xhr.readyState == 4) {
					var jsonResponse = JSON.parse(xhr.responseText);
					if (completion && jsonResponse) {
						completion(jsonResponse);
					}
				}
			}
			if (type == "POST") {
				xhr.setRequestHeader("Content-type", "application/json");
				xhr.send(JSON.stringify(data));
			} else {
				xhr.send();
			}
		}

		function sendPOSTRequest(route, data, completion) {
			sendRequest("POST", route, data, function(json) {
				if (completion) {
					completion(json["success"]);
				}
			});
		}

		function sendGETRequest(route, completion) {
			sendRequest("GET", route, null, completion);
		}

		</script>

		 <!-- Bootstrap core JavaScript
	    ================================================== -->
	    <!-- Placed at the end of the document so the pages load faster -->
	    <!-- <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script> -->
	    <script>window.jQuery || document.write('<script src="./site/assets/js/vendor/jquery.min.js"><\/script>')</script>
	    <script src="./site/dist/js/bootstrap.min.js"></script>
	    <script src="./dist/js/bootstrap-toggle.min.js"></script>
	</body>
</html>